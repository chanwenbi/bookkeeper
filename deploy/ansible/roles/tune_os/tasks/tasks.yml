---

- name: Setting present kernel params
  sysctl: name="{{ item.name }}" value="{{ item.value }}" ignoreerrors=yes state=present
  with_items:
    - { name: 'net.core.somaxconn', value: 65535 }
    - { name: 'vm.swappiness', value: 0 }
    - { name: 'net.ipv4.tcp_syncookies', value: 0 }
    - { name: 'fs.file-max', value: 1000000 }
  when: tuning_kernel_parameters

- name: Update /etc/security/limits.conf
  blockinfile:
    dest: /etc/security/limits.conf
    insertbefore: '# End of file'
    block: |
      {{ bookkeeper_service_user }}        soft        nofile        1000000
      {{ bookkeeper_service_user }}        hard        nofile        1000000
      {{ bookkeeper_service_user }}        soft        core          unlimited
      {{ bookkeeper_service_user }}        soft        stack         10240
  when: tuning_kernel_parameters

- name: Swap - disable swap
  shell: "([ $(swapon -s | wc -l) -ge 1 ] && (swapoff -a && echo disable)) || echo already"
  ignore_errors: yes
  register: swapoff_result
  changed_when: "swapoff_result.stdout.strip() == 'disable'"

- name: Create top deploy dir when under root
  file: path="{{ bookkeeper_home }}" state=directory mode=0755 owner={{ bookkeeper_service_user }} group={{ bookkeeper_service_user }}
